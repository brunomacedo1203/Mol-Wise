# üìä Google Analytics (GA4) ‚Äì Guia de Uso no Mol Class

## üéØ **IMPORTANTE: NADA PRECISA SER CONFIGURADO NO GA4!**

‚úÖ **O Google Analytics j√° est√° 100% configurado e funcionando!**  
‚úÖ **Todos os eventos aparecem automaticamente no GA4!**  
‚úÖ **Voc√™ s√≥ precisa implementar o c√≥digo do evento no projeto!**

---

## üîß Arquivos de Configura√ß√£o do Google Analytics

**Os arquivos relacionados √† configura√ß√£o do GA s√£o exatamente:**

- `src/shared/hooks/useEventTrackers.ts` - Hooks centralizados para eventos
- `src/types/gtag.d.ts` - Tipagem TypeScript (opcional)
- `src/lib/gtag.ts` - Fun√ß√µes de tracking (pageview, event, exception)
- `src/shared/hooks/useGoogleAnalytics.ts` - Pageviews autom√°ticos
- `.env.local` - Vari√°vel `NEXT_PUBLIC_GA_ID` (j√° configurada)

---

Este projeto j√° possui integra√ß√£o com o **Google Analytics 4 (GA4)** usando `gtag.js`, com configura√ß√£o centralizada, envio de pageviews e eventos personalizados.

---

## ‚úÖ Configura√ß√£o Atual

- **ID de rastreamento**: Configurado via `NEXT_PUBLIC_GA_ID`
- **Script do GA4**: Injetado no `layout.tsx` automaticamente
- **Pageviews**: Enviados automaticamente via `useGoogleAnalytics`
- **Eventos**: Enviados via fun√ß√µes utilit√°rias em `gtag.ts`
- **Privacidade**: Ativada (`anonymize_ip: true`)
- **Status**: ‚úÖ **FUNCIONANDO PERFEITAMENTE!**

---

## üß† Como o GA4 funciona aqui

| Item                        | Fun√ß√£o                                                           |
| --------------------------- | ---------------------------------------------------------------- |
| `gtag.ts`                   | Cont√©m fun√ß√µes de rastreamento: `pageview`, `event`, `exception` |
| `useGoogleAnalytics.ts`     | Hook que envia `pageview` ao mudar de rota                       |
| **Script no `layout.tsx`**  | Inicia o GA4 e injeta o `gtag()` no `window`                     |
| **Evento `search_element`** | Exemplo de evento custom j√° implementado                         |

---

## üìÇ Arquivos Principais da Arquitetura

### üéØ **4 Arquivos Essenciais para Google Analytics**

Estes s√£o os **arquivos principais** que formam a arquitetura completa do GA4:

```
src/
‚îú‚îÄ‚îÄ app/[locale]/
‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx              # üîß Configura√ß√£o global e inicializa√ß√£o do GA4
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ gtag.ts                 # üìö Biblioteca principal com fun√ß√µes de tracking
‚îî‚îÄ‚îÄ shared/hooks/
    ‚îú‚îÄ‚îÄ useGoogleAnalytics.ts   # üîÑ Hook para pageviews autom√°ticos
    ‚îú‚îÄ‚îÄ useEventTrackers.ts     # üéØ Hooks padronizados para eventos espec√≠ficos
    ‚îî‚îÄ‚îÄ useDebouncedValue.ts    # ‚è±Ô∏è Hook para debounce de valores (digita√ß√£o)
```

### üìã **Fun√ß√£o de Cada Arquivo**

| Arquivo                 | Responsabilidade                                  | Status            |
| ----------------------- | ------------------------------------------------- | ----------------- |
| `layout.tsx`            | Injeta scripts do GA4, configura ID e privacidade | ‚úÖ **Essencial**  |
| `gtag.ts`               | Fun√ß√µes `pageview()`, `event()`, `exception()`    | ‚úÖ **Essencial**  |
| `useGoogleAnalytics.ts` | Pageviews autom√°ticos em mudan√ßas de rota         | ‚úÖ **Essencial**  |
| `useEventTrackers.ts`   | Hooks para eventos padronizados                   | ‚úÖ **Essencial**  |
| `useDebouncedValue.ts`  | Controle de debounce para inputs e eventos        | üîß **Utilit√°rio** |

### üõ†Ô∏è **Hooks Utilit√°rios**

#### `useDebouncedValue.ts` - Controle de Digita√ß√£o

Hook criado para aplicar debounce em valores de entrada, especialmente √∫til para:

- **Campos de busca** que disparam eventos GA4
- **Filtros em tempo real** que precisam de otimiza√ß√£o
- **Qualquer input** que requer controle de frequ√™ncia

```ts
import { useDebouncedValue } from "@/shared/hooks/useDebouncedValue";

const [searchTerm, setSearchTerm] = useState("");
const debouncedSearchTerm = useDebouncedValue(searchTerm, 500);

// Dispara evento GA4 apenas ap√≥s 500ms de inatividade
useEffect(() => {
  if (debouncedSearchTerm) {
    trackElementSearch({ search_term: debouncedSearchTerm });
  }
}, [debouncedSearchTerm]);
```

**Benef√≠cios:**

- ‚úÖ Evita spam de eventos GA4 durante digita√ß√£o
- ‚úÖ Melhora performance da aplica√ß√£o
- ‚úÖ Reduz custos de API calls
- ‚úÖ Experi√™ncia de usu√°rio mais fluida

---

### üöÄ **Para Adicionar Novos Eventos**

Com esta arquitetura, voc√™ pode:

1. **Usar diretamente**: `import { event } from "@/lib/gtag"`
2. **Criar hook espec√≠fico**: Adicionar em `useEventTrackers.ts`
3. **Criar arquivo espec√≠fico**: Como `searchEvents.ts` para features
4. **Usar debounce**: Combinar com `useDebouncedValue` para inputs

---

## üß© Fun√ß√µes Dispon√≠veis

### 1. `pageview(url: string)`

Envia um pageview manual (normalmente j√° feito automaticamente via `useGoogleAnalytics`).

```ts
import { pageview } from "@/lib/gtag";

pageview("/catalog?filter=metal");
```

---

### 2. `event(name: string, params?: object)`

Envia um evento GA4 com par√¢metros personalizados.

```ts
import { event } from "@/lib/gtag";

event("search_element", {
  search_term: "H2O",
  result_count: 5,
  section: "catalog",
});
```

---

### 3. `exception(description: string, fatal?: boolean)`

Registra um erro (exemplo √∫til em try/catch).

```ts
import { exception } from "@/lib/gtag";

exception("Erro no c√°lculo", false);
```

---

## üìã Resumo: Padr√£o Baseado no `search_element`

### **üîÑ Sequ√™ncia de Arquivos (Ordem de Implementa√ß√£o):**

1. **`e:\Projetos\Mol Class\src\types\gtag.d.ts`** - Adicionar tipos espec√≠ficos (opcional)
2. **`e:\Projetos\Mol Class\src\features\[feature]\events\[eventName]Events.ts`** - Criar fun√ß√£o de tracking espec√≠fica
3. **`e:\Projetos\Mol Class\src\shared\hooks\useEventTrackers.ts`** - Adicionar hook centralizado (alternativa)
4. **`e:\Projetos\Mol Class\src\features\[feature]\components\[Component].tsx`** - Implementar no componente
5. **`e:\Projetos\Mol Class\src\components\debug\GADebugger.tsx`** - Testar o evento

### **üìÅ Exemplo Real do `search_element`:**

**Arquivo 1:** `src/features/periodic-table/events/searchEvents.ts`

```ts
import { event } from "@/lib/gtag";

export const trackElementSearch = ({
  search_term,
  section = "periodic_table",
}: {
  search_term: string;
  section?: string;
}): void => {
  console.log("[SEARCH_EVENTS] Disparando trackElementSearch:", {
    search_term,
    section,
  });
  event("search_element", {
    search_term,
    section,
  });
};
```

**Arquivo 2:** `src/features/periodic-table/components/ElementDetailsPanel.tsx`

```ts
import { trackElementSearch } from "../events/searchEvents";

const handleSearch = (value: string) => {
  setSearch(value);
  setSearchValue(value);

  if (value.trim() !== "") {
    trackElementSearch({ search_term: value });
  }
};
```

**Arquivo 3:** `src/shared/hooks/useEventTrackers.ts` (Alternativa)

```ts
const trackElementSearch = ({
  symbol,
  name,
  atomic_number,
  section = "periodic_table",
}) => {
  event("search_element", { symbol, name, atomic_number, section });
};
```

### **üéØ Estrutura Recomendada:**

- **Eventos espec√≠ficos**: `src/features/[feature]/events/`
- **Hooks centralizados**: `src/shared/hooks/useEventTrackers.ts`
- **Tipagem**: `src/types/gtag.d.ts`
- **Implementa√ß√£o**: Componentes da feature

---

## üöÄ **COMO IMPLEMENTAR NOVOS EVENTOS (3 OP√á√ïES)**

### **üéØ OP√á√ÉO 1: Uso Direto (Mais Simples)**

Para eventos simples, use diretamente a fun√ß√£o `event`:

```ts
import { event } from "@/lib/gtag";

// Exemplo: Evento de clique em bot√£o
const handleButtonClick = () => {
  event("button_click", {
    button_name: "download_pdf",
    section: "element_details",
  });
};

// Exemplo: Evento de busca
const handleSearch = (searchTerm: string) => {
  event("search", {
    search_term: searchTerm,
    section: "catalog",
  });
};
```

**‚úÖ Vantagens**: Simples, direto, sem arquivos extras  
**‚ùå Desvantagens**: C√≥digo duplicado se usar em v√°rios lugares

---

### **üéØ OP√á√ÉO 2: Arquivo Espec√≠fico da Feature (Recomendado)**

Crie um arquivo espec√≠fico para eventos da sua feature:

```ts
// src/features/calculators/events/calculationEvents.ts
import { event } from "@/lib/gtag";

export const trackCalculation = ({
  calculator_type,
  formula_input,
  result_value,
  section = "calculators",
}: {
  calculator_type: string;
  formula_input: string;
  result_value: number;
  section?: string;
}): void => {
  console.log("[CALCULATION_EVENTS] Disparando trackCalculation:", {
    calculator_type,
    formula_input,
    result_value,
    section,
  });

  event("calculation_performed", {
    calculator_type,
    formula_input,
    result_value,
    section,
  });
};
```

**No componente:**

```ts
import { trackCalculation } from "../events/calculationEvents";

const handleCalculate = (formula: string, result: number) => {
  // Sua l√≥gica de c√°lculo...

  // Disparar evento GA
  trackCalculation({
    calculator_type: "molar_mass",
    formula_input: formula,
    result_value: result,
  });
};
```

**‚úÖ Vantagens**: Organizado, reutiliz√°vel, f√°cil de manter  
**‚ùå Desvantagens**: Precisa criar arquivo

---

### **üéØ OP√á√ÉO 3: Hook Centralizado (Para Eventos Globais)**

Adicione no hook centralizado `useEventTrackers.ts`:

```ts
// src/shared/hooks/useEventTrackers.ts
import { event } from "@/lib/gtag";

export function useEventTrackers() {
  const trackCalculation = ({
    calculator_type,
    formula_input,
    result_value,
    section = "calculators",
  }: {
    calculator_type: string;
    formula_input: string;
    result_value: number;
    section?: string;
  }) => {
    event("calculation_performed", {
      calculator_type,
      formula_input,
      result_value,
      section,
    });
  };

  return {
    trackCalculation,
    // outros hooks...
  };
}
```

**No componente:**

```ts
import { useEventTrackers } from "@/shared/hooks/useEventTrackers";

const MolarMassCalculator = () => {
  const { trackCalculation } = useEventTrackers();

  const handleCalculate = (formula: string, result: number) => {
    trackCalculation({
      calculator_type: "molar_mass",
      formula_input: formula,
      result_value: result,
    });
  };
};
```

**‚úÖ Vantagens**: Centralizado, dispon√≠vel em qualquer lugar  
**‚ùå Desvantagens**: Arquivo pode ficar grande

---

## üîç **COMO VERIFICAR SE EST√Å FUNCIONANDO**

### **1. Console do Navegador (Imediato)**

Abra DevTools ‚Üí Console e veja logs como:

```
[CALCULATION_EVENTS] Disparando trackCalculation: {...}
```

### **2. GA4 Real-time (1-2 minutos)**

1. Acesse **Google Analytics ‚Üí Relat√≥rios ‚Üí Tempo real**
2. Interaja com sua funcionalidade
3. Veja o evento aparecer na lista

### **3. GA4 Eventos (5-10 minutos)**

1. Acesse **Google Analytics ‚Üí Relat√≥rios ‚Üí Eventos**
2. Procure por seu evento na lista
3. Clique para ver os par√¢metros enviados

---

## ‚ö†Ô∏è **IMPORTANTE: NADA PRECISA SER CONFIGURADO NO GA4!**

- ‚úÖ **Eventos aparecem automaticamente**
- ‚úÖ **Par√¢metros s√£o enviados automaticamente**
- ‚úÖ **Relat√≥rios s√£o gerados automaticamente**
- ‚úÖ **Tudo funciona "out of the box"**

**Voc√™ s√≥ precisa:**

1. Implementar o c√≥digo do evento
2. Testar no navegador
3. Verificar no GA4 (opcional)

---

## üìã **EXEMPLO PR√ÅTICO: Evento de Busca de Mol√©culas**

Aqui est√° um exemplo real implementado no projeto para busca de mol√©culas no visualizador:

### **Arquivo de Evento:**

```ts
// src/features/visualization/events/moleculeSearchEvents.ts
import { event } from "@/lib/gtag";

export const trackMoleculeSearch = ({
  search_term,
  section = "molecule_visualizer",
  search_type,
  success = false,
}: {
  search_term: string;
  section?: string;
  search_type?: "name" | "formula" | "smiles" | "cid" | "unknown";
  success?: boolean;
}): void => {
  console.log("[MOLECULE_SEARCH_EVENTS] Disparando trackMoleculeSearch:", {
    search_term,
    section,
    search_type,
    success,
  });

  event("search", {
    search_term,
    section,
    search_type,
    success,
  });
};
```

### **Integra√ß√£o no Componente:**

```ts
// src/features/visualization/components/MoleculeToolbar.tsx
import { trackMoleculeSearch } from "../events/moleculeSearchEvents";

const handleSearch = async (query: string) => {
  const searchType = detectSearchType(query);

  try {
    // Sua l√≥gica de busca...
    const result = await searchMolecule(query);

    // Tracking de busca bem-sucedida
    trackMoleculeSearch({
      search_term: query,
      search_type: searchType,
      success: true,
    });
  } catch (error) {
    // Tracking de busca falhada
    trackMoleculeSearch({
      search_term: query,
      search_type: searchType,
      success: false,
    });
  }
};
```

### **O que aparece no GA4:**

- **Evento**: `search`
- **Par√¢metros**:
  - `search_term`: "benzene" (o que foi digitado)
  - `section`: "molecule_visualizer"
  - `search_type`: "name" (detectado automaticamente)
  - `success`: true/false

---

## üîé Como testar

1. Abra o site com `?debug_mode=true` na URL
2. V√° ao GA4 ‚Üí Admin ‚Üí DebugView
3. Interaja com a aplica√ß√£o
4. Verifique se eventos aparecem corretamente
5. No DevTools ‚Üí aba Network ‚Üí filtre por `collect` e veja status `204`

---

## üîê Privacidade e Cookies

O GA4 est√° configurado com:

- `anonymize_ip: true` ‚Üí os IPs dos usu√°rios s√£o anonimizados
- `cookie_flags: 'SameSite=None;Secure'` ‚Üí cookies seguros, compat√≠veis com m√∫ltiplos navegadores

---

## üìå Observa√ß√µes

- Evite usar os padr√µes antigos (`category`, `action`, `label`, `value`) do Universal Analytics.
- No GA4, os eventos s√£o **livres** e organizados via **par√¢metros nomeados**.
- Eventos como `search`, `view_item`, `generate_lead` t√™m tratamento especial e s√£o recomendados.

---

## üìã Exemplo de Evento Nomeado (recomendado)

```ts
event("view_item", {
  item_id: "Na",
  item_name: "S√≥dio",
  item_type: "element",
});
```

---

---

## üöÄ **RESUMO R√ÅPIDO: Como Adicionar um Novo Evento**

### **1. Escolha uma das 3 op√ß√µes:**

- **Simples**: `event('nome_do_evento', { param1: 'valor' })`
- **Organizado**: Crie `src/features/[feature]/events/[evento]Events.ts`
- **Global**: Adicione em `src/shared/hooks/useEventTrackers.ts`

### **2. Implemente no componente:**

```ts
import { event } from "@/lib/gtag";
// ou
import { trackMeuEvento } from "../events/meuEventoEvents";

// Disparar evento
event("meu_evento", { section: "minha_secao" });
```

### **3. Teste:**

- Console do navegador ‚Üí veja os logs
- GA4 Real-time ‚Üí veja o evento aparecer
- GA4 Eventos ‚Üí veja os par√¢metros

### **4. Pronto!**

- ‚úÖ **Nada mais precisa ser configurado**
- ‚úÖ **Evento aparece automaticamente no GA4**
- ‚úÖ **Par√¢metros s√£o enviados automaticamente**

---

Pronto! Agora sua base de Analytics est√° preparada para escalar com seguran√ßa, organiza√ß√£o e clareza. ‚ú®
